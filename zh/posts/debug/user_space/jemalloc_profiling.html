<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.13" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.48" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://emptywatson.github.io/zh/posts/debug/user_space/jemalloc_profiling.html"><meta property="og:site_name" content="EmptyWatson Inside World"><meta property="og:title" content="Jemalloc切片-跟踪内存泄漏和内存增长"><meta property="og:description" content="Jemalloc切片-跟踪内存泄漏和内存增长 使用Jemalloc Profiling跟踪内存泄漏和内存增长问题 今天给大家介绍一种依靠内存分配器自带能力来跟踪内存泄漏问题的方法。保证这是一个好的方法，是经过多年检验的方法。 但是，这不是最好的，因为没有银弹。 1. 开篇问题 在一个内存密集型的代码量超过40W行的C++编写的系统中： 定位一个慢内存泄..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-06-14T07:39:05.000Z"><meta property="article:author" content="EmptyWatson"><meta property="article:tag" content="调试技巧"><meta property="article:tag" content="Jemalloc"><meta property="article:tag" content="内存泄漏"><meta property="article:tag" content="内存增长"><meta property="article:tag" content="Profiling"><meta property="article:published_time" content="2021-09-04T00:00:00.000Z"><meta property="article:modified_time" content="2024-06-14T07:39:05.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Jemalloc切片-跟踪内存泄漏和内存增长","image":[""],"datePublished":"2021-09-04T00:00:00.000Z","dateModified":"2024-06-14T07:39:05.000Z","author":[{"@type":"Person","name":"EmptyWatson","url":"https://emptywatson.github.io/"}]}</script><title>Jemalloc切片-跟踪内存泄漏和内存增长 | EmptyWatson Inside World</title><meta name="description" content="Jemalloc切片-跟踪内存泄漏和内存增长 使用Jemalloc Profiling跟踪内存泄漏和内存增长问题 今天给大家介绍一种依靠内存分配器自带能力来跟踪内存泄漏问题的方法。保证这是一个好的方法，是经过多年检验的方法。 但是，这不是最好的，因为没有银弹。 1. 开篇问题 在一个内存密集型的代码量超过40W行的C++编写的系统中： 定位一个慢内存泄...">
    <link rel="preload" href="/assets/style-bp6kzVCU.css" as="style"><link rel="stylesheet" href="/assets/style-bp6kzVCU.css">
    <link rel="modulepreload" href="/assets/app-Dc7jvRXf.js"><link rel="modulepreload" href="/assets/jemalloc_profiling.html-D7LtvIUt.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/assets/index.html-DBhNjpl6.js" as="script"><link rel="prefetch" href="/assets/intro.html-CqFqIcXz.js" as="script"><link rel="prefetch" href="/assets/index.html-Djv8-br_.js" as="script"><link rel="prefetch" href="/assets/intro.html-BS8FJIEW.js" as="script"><link rel="prefetch" href="/assets/index.html-D3v0eLsI.js" as="script"><link rel="prefetch" href="/assets/disable.html-smZcKC7m.js" as="script"><link rel="prefetch" href="/assets/encrypt.html-0wOBY2u3.js" as="script"><link rel="prefetch" href="/assets/layout.html-FiYPtW-l.js" as="script"><link rel="prefetch" href="/assets/markdown.html-K84Sho_c.js" as="script"><link rel="prefetch" href="/assets/page.html-CBHxG1ui.js" as="script"><link rel="prefetch" href="/assets/cherry.html-Ca4pXJlk.js" as="script"><link rel="prefetch" href="/assets/dragonfruit.html-CRfpdzmd.js" as="script"><link rel="prefetch" href="/assets/strawberry.html-Dp5C_Byo.js" as="script"><link rel="prefetch" href="/assets/tomato.html-4dax1wM8.js" as="script"><link rel="prefetch" href="/assets/tools.html-DvsJ1VNs.js" as="script"><link rel="prefetch" href="/assets/1.html-B-5V11yF.js" as="script"><link rel="prefetch" href="/assets/2.html-WJCfxOEf.js" as="script"><link rel="prefetch" href="/assets/3.html-Baws7hge.js" as="script"><link rel="prefetch" href="/assets/4.html-BGK4oA8O.js" as="script"><link rel="prefetch" href="/assets/1.html-BssFQF1P.js" as="script"><link rel="prefetch" href="/assets/2.html-byrMovYT.js" as="script"><link rel="prefetch" href="/assets/3.html-C-r1bB6j.js" as="script"><link rel="prefetch" href="/assets/4.html-CHkz-xNg.js" as="script"><link rel="prefetch" href="/assets/linux_freeze_threads.html-DZ2vuEHZ.js" as="script"><link rel="prefetch" href="/assets/Software_Concept_World.html-CZEnMAtf.js" as="script"><link rel="prefetch" href="/assets/404.html-OAeyzWcR.js" as="script"><link rel="prefetch" href="/assets/index.html-BSzXoL_1.js" as="script"><link rel="prefetch" href="/assets/index.html-DcxxJ_Dv.js" as="script"><link rel="prefetch" href="/assets/index.html-BpH4_ogO.js" as="script"><link rel="prefetch" href="/assets/index.html-BOZjI8Fy.js" as="script"><link rel="prefetch" href="/assets/index.html-Dd_12tGu.js" as="script"><link rel="prefetch" href="/assets/index.html-DvjKZaad.js" as="script"><link rel="prefetch" href="/assets/index.html-CYTv1FXy.js" as="script"><link rel="prefetch" href="/assets/index.html-1Kr9yCEf.js" as="script"><link rel="prefetch" href="/assets/index.html-NDmjYaW5.js" as="script"><link rel="prefetch" href="/assets/index.html-DMhtql7M.js" as="script"><link rel="prefetch" href="/assets/index.html-enpxekQf.js" as="script"><link rel="prefetch" href="/assets/index.html-B8mw9L3B.js" as="script"><link rel="prefetch" href="/assets/index.html-nVGxAgRH.js" as="script"><link rel="prefetch" href="/assets/index.html-YzFMuLIq.js" as="script"><link rel="prefetch" href="/assets/index.html-B_Qs87xr.js" as="script"><link rel="prefetch" href="/assets/index.html-Bi5ulq31.js" as="script"><link rel="prefetch" href="/assets/index.html-BFH5KnE0.js" as="script"><link rel="prefetch" href="/assets/index.html-BQMxxj_t.js" as="script"><link rel="prefetch" href="/assets/index.html-DEA3qRAL.js" as="script"><link rel="prefetch" href="/assets/index.html-BUghlfiF.js" as="script"><link rel="prefetch" href="/assets/index.html-CkfC2hgc.js" as="script"><link rel="prefetch" href="/assets/index.html-CRcE6e9g.js" as="script"><link rel="prefetch" href="/assets/index.html-CvkG5Uf9.js" as="script"><link rel="prefetch" href="/assets/index.html-DSdlgBMk.js" as="script"><link rel="prefetch" href="/assets/index.html-CUqvJoOS.js" as="script"><link rel="prefetch" href="/assets/index.html-iBExz_PV.js" as="script"><link rel="prefetch" href="/assets/index.html-EpDwqpAL.js" as="script"><link rel="prefetch" href="/assets/index.html-BEiJcwR4.js" as="script"><link rel="prefetch" href="/assets/index.html-DPzVQDru.js" as="script"><link rel="prefetch" href="/assets/index.html-BFkUYSfT.js" as="script"><link rel="prefetch" href="/assets/index.html-D0DNyX3E.js" as="script"><link rel="prefetch" href="/assets/index.html-B92RdDdk.js" as="script"><link rel="prefetch" href="/assets/index.html-BZwpZTH6.js" as="script"><link rel="prefetch" href="/assets/index.html-DII4QMaq.js" as="script"><link rel="prefetch" href="/assets/index.html-CCAIpbdK.js" as="script"><link rel="prefetch" href="/assets/index.html-BFx-RJkH.js" as="script"><link rel="prefetch" href="/assets/index.html-gwLQDR4P.js" as="script"><link rel="prefetch" href="/assets/index.html-BnnGsXgO.js" as="script"><link rel="prefetch" href="/assets/index.html-B6GSNLJH.js" as="script"><link rel="prefetch" href="/assets/index.html-DymRwqkA.js" as="script"><link rel="prefetch" href="/assets/index.html-CLdyxWlR.js" as="script"><link rel="prefetch" href="/assets/index.html-CfIf1uHL.js" as="script"><link rel="prefetch" href="/assets/index.html-TkmrIp2L.js" as="script"><link rel="prefetch" href="/assets/index.html-B088dt3L.js" as="script"><link rel="prefetch" href="/assets/index.html-CsNHH2XH.js" as="script"><link rel="prefetch" href="/assets/index.html-B7X9Y3ht.js" as="script"><link rel="prefetch" href="/assets/index.html-Be7CmnKF.js" as="script"><link rel="prefetch" href="/assets/index.html-ZvdIBxCM.js" as="script"><link rel="prefetch" href="/assets/index.html-BsrbdXQX.js" as="script"><link rel="prefetch" href="/assets/index.html-DoYMT_1L.js" as="script"><link rel="prefetch" href="/assets/index.html-CdC-bi4b.js" as="script"><link rel="prefetch" href="/assets/index.html-DJQ4UUCq.js" as="script"><link rel="prefetch" href="/assets/index.html-D_X0W82S.js" as="script"><link rel="prefetch" href="/assets/index.html-CH7x6IWz.js" as="script"><link rel="prefetch" href="/assets/index.html-pAj6kkdv.js" as="script"><link rel="prefetch" href="/assets/index.html-C5yKvJhi.js" as="script"><link rel="prefetch" href="/assets/index.html-Hc4PSexY.js" as="script"><link rel="prefetch" href="/assets/index.html-Bqc6DS5J.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-GXRgw7eJ.js" as="script"><link rel="prefetch" href="/assets/SearchResult-DIw0nVd6.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/zh/"><img class="vp-nav-logo" src="/logo.svg" alt><!----><span class="vp-site-name hide-in-pad">EmptyWatson Inside World</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/zh/" aria-label="博客主页"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span><!--]-->博客主页<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link route-link-active auto-link" href="/zh/posts/" aria-label="博文"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span><!--]-->博文<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="工具"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-tools" style=""></span>工具<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="auto-link external-link" href="/tools/gluc-ahp-front/#/" aria-label="gluc-ahp-front" rel="noopener noreferrer" target="_blank"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-tools" style=""></span><!--]-->gluc-ahp-front<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/zh/intro.html" aria-label="关于"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-intro" style=""></span><!--]-->关于<!----></a></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><div class="vp-nav-item"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="选择语言"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon i18n-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="i18n icon" name="i18n" style="width:1rem;height:1rem;vertical-align:middle;"><path d="M379.392 460.8 494.08 575.488l-42.496 102.4L307.2 532.48 138.24 701.44l-71.68-72.704L234.496 460.8l-45.056-45.056c-27.136-27.136-51.2-66.56-66.56-108.544h112.64c7.68 14.336 16.896 27.136 26.112 35.84l45.568 46.08 45.056-45.056C382.976 312.32 409.6 247.808 409.6 204.8H0V102.4h256V0h102.4v102.4h256v102.4H512c0 70.144-37.888 161.28-87.04 210.944L378.88 460.8zM576 870.4 512 1024H409.6l256-614.4H768l256 614.4H921.6l-64-153.6H576zM618.496 768h196.608L716.8 532.48 618.496 768z"></path></svg><!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link route-link-active auto-link" href="/zh/posts/debug/user_space/jemalloc_profiling.html" aria-label="简体中文"><!---->简体中文<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/en/" aria-label="English"><!---->English<!----></a></li></ul></button></div></div><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/EmptyWatson/EmptyWatson.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-color-mode-switch" id="color-mode-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" name="auto" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" name="dark" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" name="light" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/zh/" aria-label="博客主页"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span><!--]-->博客主页<!----></a></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable active"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><a class="route-link route-link-active auto-link vp-sidebar-title no-external-link-icon" href="/zh/posts/" aria-label="文章"><!---->文章<!----></a><!----></p><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable"><!----><a class="route-link auto-link vp-sidebar-title no-external-link-icon" href="/zh/posts/philosophy/" aria-label="哲学"><!---->哲学<!----></a><!----></p><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable"><!----><a class="route-link auto-link vp-sidebar-title no-external-link-icon" href="/zh/posts/philosophy/software/" aria-label="软件"><!---->软件<!----></a><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/zh/posts/philosophy/software/Software_Concept_World.html" aria-label="软件概念世界"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span><!--]-->软件概念世界<!----></a></li></ul></section></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable active"><!----><a class="route-link route-link-active auto-link vp-sidebar-title no-external-link-icon" href="/zh/posts/debug/" aria-label="调试"><!---->调试<!----></a><!----></p><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable active"><!----><a class="route-link route-link-active auto-link vp-sidebar-title no-external-link-icon" href="/zh/posts/debug/user_space/" aria-label="用户空间"><!---->用户空间<!----></a><!----></p><ul class="vp-sidebar-links"><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/zh/posts/debug/user_space/jemalloc_profiling.html" aria-label="Jemalloc切片-跟踪内存泄漏和内存增长"><!---->Jemalloc切片-跟踪内存泄漏和内存增长<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/zh/posts/debug/user_space/linux_freeze_threads.html" aria-label="Linux上暂停指定的多个运行线程"><!---->Linux上暂停指定的多个运行线程<!----></a></li></ul></section></li></ul></section></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable"><span class="font-icon icon fa-fw fa-sm fas fa-tools" style=""></span><a class="route-link auto-link vp-sidebar-title no-external-link-icon" href="/zh/tools/" aria-label="工具"><!---->工具<!----></a><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/zh/tools/tools.html" aria-label="工具列表"><!---->工具列表<!----></a></li></ul></section></li><li><a class="route-link auto-link vp-sidebar-link" href="/zh/intro.html" aria-label="介绍页"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-circle-info" style=""></span><!--]-->介绍页<!----></a></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Jemalloc切片-跟踪内存泄漏和内存增长</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://emptywatson.github.io/" target="_blank" rel="noopener noreferrer">EmptyWatson</a></span><span property="author" content="EmptyWatson"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2021-09-04T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 27 分钟</span><meta property="timeRequired" content="PT27M"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color4 clickable" role="navigation">调试</span><span class="page-category-item color6 clickable" role="navigation">Profiling</span><!--]--><meta property="articleSection" content="调试,Profiling"></span><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color2 clickable" role="navigation">调试技巧</span><span class="page-tag-item color8 clickable" role="navigation">Jemalloc</span><span class="page-tag-item color8 clickable" role="navigation">内存泄漏</span><span class="page-tag-item color0 clickable" role="navigation">内存增长</span><span class="page-tag-item color6 clickable" role="navigation">Profiling</span><!--]--><meta property="keywords" content="调试技巧,Jemalloc,内存泄漏,内存增长,Profiling"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_1-开篇问题">1. 开篇问题</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_2-关于jemalloc">2. 关于jemalloc</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_3-内存泄漏">3. 内存泄漏</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_4-profiling的内在逻辑">4. Profiling的内在逻辑</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_5-jemalloc的使用方式">5. Jemalloc的使用方式</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_6-jemalloc的安装">6. Jemalloc的安装</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_7-jemalloc关键文件说明">7. Jemalloc关键文件说明</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_8-编译带prof功能的jemalloc库">8. 编译带prof功能的jemalloc库</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_9-内存泄漏和内存增长测试例子">9. 内存泄漏和内存增长测试例子</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_10-编译测试程序">10. 编译测试程序</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_11-jemalloc运行时控制">11. Jemalloc运行时控制</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_11-2-通过接口">11.2  通过接口</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_11-3-启用和激活prof">11.3  启用和激活prof</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_11-4-profiling的输出">11.4  profiling的输出</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_11-5-profiling的基本流程">11.5  profiling的基本流程：</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_11-6-触发profiling的2类方法">11.6  触发profiling的2类方法</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_12-测试-直接使用内存泄漏检查功能">12. 测试：直接使用内存泄漏检查功能</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_13-测试-通过heap对比来分析泄漏和增长">13. 测试：通过heap对比来分析泄漏和增长</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_14-jeprof工具的用法举例">14. jeprof工具的用法举例</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_15-jemalloc内存切片的缺陷">15. Jemalloc内存切片的缺陷</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_16-最后">16. 最后</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#参考资料">参考资料：</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><h1 id="jemalloc切片-跟踪内存泄漏和内存增长" tabindex="-1"><a class="header-anchor" href="#jemalloc切片-跟踪内存泄漏和内存增长"><span>Jemalloc切片-跟踪内存泄漏和内存增长</span></a></h1><p>使用Jemalloc Profiling跟踪内存泄漏和内存增长问题</p><p>今天给大家介绍一种依靠内存分配器自带能力来跟踪内存泄漏问题的方法。保证这是一个好的方法，是经过多年检验的方法。</p><p>但是，这不是最好的，因为没有银弹。</p><h2 id="_1-开篇问题" tabindex="-1"><a class="header-anchor" href="#_1-开篇问题"><span><strong>1. 开篇问题</strong></span></a></h2><p>在一个内存密集型的代码量超过40W行的C++编写的系统中：</p><ol><li><p>定位一个慢内存泄漏问题(比如跑了1天，泄漏了10GB内存)，该怎么办？</p></li><li><p>启动运行10分钟后，服务器内存消耗了20GB，然后内存就稳定了，存在内存消耗过高的问题，为了优化内存消耗，现在需要找出这些内存消耗的热点，该怎么办？</p></li></ol><p>如果你维护的项目代码总量不过数千行。</p><p>或者你对业务和代码细节足够熟悉，以至于你知道每一个malloc/new申请了多少内存，哪个流程最耗内存(我想你应该没有这么有信心)。</p><p>那么今天介绍的方法或许对你的意义不大。</p><p>如果你遇到了开篇提出的类似问题。</p><p><strong>并且：</strong></p><p>你刚接手这个规模较大的系统，</p><p>或者你正在维护由非常多的模块构成的一个大系统，</p><p>或者现在的情况比较棘手，你需要把锅甩出去，急于撇清跟自己所维护的模块的关系。</p><p><strong>并且：</strong></p><p>你曾经尝试过内存问题跟踪神器valgrind，但是你实在受不了它乌龟一样的速度，</p><p>或者很不幸，你的工程在使用valgrind时遇到了各种报错，根本跑步起来。</p><p><strong>并且：</strong></p><p>你的程序不是一个对实时性有变态要求的程序。</p><p><strong>并且：</strong></p><p>你遭遇的这个问题最好是能够重现的，或者很容易重现的。</p><p>如果不能重现，不好意思这不是什么问题，不用看这篇文章，直接交给运营去填坑，让他们在24点时重启下程序吧。</p><p><strong>并且：</strong></p><p>你有权力重启你的程序。</p><p><strong>并且：</strong></p><p>最好不是生产环境。</p><p><strong>并且：</strong></p><p>你打开了中文搜索引擎，搜索了“怎么跟踪内存泄漏”，没有找到适合的方法。</p><p><strong>并且：</strong></p><p>你至少得有1天的时间，不然你踩到了坑，时间不就没有了吗，所以给自己预留些时间。</p><p><strong>并且：</strong></p><p>你的程序在Linux上运行，如果是Windows，我想你应该有更好的方法。</p><p>Windows上应该也可以，不过我还没研究过。</p><p>没有并且了。</p><p>那么，你可以了解下本文提供的方法。</p><p>我想你应该是C/C++程序员，不然你怎么会遇到这些问题？</p><p>或者你遇到了这些问题怎么会来这里找方法？</p><p>其实今天讲的方法对java/python等其他语言也适用，不过你可能还得借助些其他的工具。</p><h2 id="_2-关于jemalloc" tabindex="-1"><a class="header-anchor" href="#_2-关于jemalloc"><span><strong>2. 关于jemalloc</strong></span></a></h2><p>C/C++程序员都使用过内存分配器，不管你知不知道什么是内存分配器，只要你调用过malloc函数，你就使用了它。</p><p>在linux上，ptmalloc是glibc的默认内存分配器，它提供了malloc和free这样的动态分配内存和归还的能力。</p><p>本文讲的jemalloc是另外一个，除此之外还有好多内存分配器，比较出名的还有：tcmalloc，mimalloc。</p><p>如果你之前不知道它们的存在，你可能需要花几分钟去了解一下了。</p><p>之所以有这么多种内存分配器，主要还是为了追求内存使用的性能表现，包括减少CPU开销，减少内存使用量。</p><p>内存分配器的性能问题是另外一个非常大的话题，本文不展开讨论。</p><p>jemalloc出自facebook，tcmalloc出自google，mimalloc出自microsoft。</p><p>并且，都开源：</p><p>jemalloc：</p><p><a href="https://github.com/jemalloc/jemalloc" target="_blank" rel="noopener noreferrer">https://github.com/jemalloc/jemalloc</a></p><p>tcmalloc：</p><p><a href="https://github.com/google/tcmalloc" target="_blank" rel="noopener noreferrer">https://github.com/google/tcmalloc </a></p><p>mimalloc：</p><p><a href="https://github.com/microsoft/mimalloc" target="_blank" rel="noopener noreferrer">https://github.com/microsoft/mimalloc</a></p><p>巨头对基础技术的研究还是很舍得投入。</p><p>这几个内存分配器我都尝试过，它们都很优秀。</p><p>今天的主题还是内存切片问题，所以得以jemalloc为例，其实tcmalloc也具备类似的能力。</p><h2 id="_3-内存泄漏" tabindex="-1"><a class="header-anchor" href="#_3-内存泄漏"><span><strong>3. 内存泄漏</strong></span></a></h2><p>关于内存泄漏问题，大家可以去读读 维基百科 和 百度百科 的描述，很有参考价值。</p><p>内存泄漏问题，表现为随着时间的前进，物理内存消耗越来越多。</p><p>严重时，以至于发展到系统无物理内存可分配，导致系统主动进行OOM，最终造成程序被操作系统异常终止。</p><p>不同的原因造成的内存泄漏表现也各不相同。</p><p>泄漏的内在含义表现在：<strong>资源</strong>和 <strong>可控性</strong>，这两者上。</p><p><strong>资源：</strong></p><p>资源当然是内存资源，在linux操作系统上内存资源包含2个大的部分：<strong>虚拟内存资源</strong> 和 <strong>物理内存资源</strong>。</p><p>如果泄漏仅仅发生在虚拟内存资源上，那么你可能不会那么快感受到问题，现代的CPU和操作系统往往都是64位的，他们拥有非常大的地址空间，不是一下就能消耗完。</p><p>物理内存资源往往相对比较紧缺，大量的泄漏必定造成资源匮乏。</p><p>资源都有存放的位置，内存泄漏往往是发生在进程空间中的堆空间中，堆是动态内存申请的最主要的场地，也是我们工程实践过程中内存泄漏发生的主要位置。</p><p>也有一部分内存泄漏发生在栈空间中，但是非常少见，举个例子，频繁的创建线程而不回收线程就会造成栈内存泄露，当然不回收线程带来的后果比栈内存泄漏更严重。</p><p><strong>可控性：</strong></p><p>只有内存资源的控制权丢失，程序内存消耗表现不符合业务需求，这种情况才是内存泄漏。</p><p>内存资源的控制权本应该掌握在编码者的预期表现所框定的范围内，但是程序可能由于各种原因出现了偏差，所以是编程者丧失了对程序行为表现的控制权。</p><p>比如是编码者忘记了释放申请的内存，或者是智能指针循环引用，或者内存句柄被破坏等等等具体的泄漏原因，这些都是由于内存资源的控制权丧失造成内存资源不可控而出现的内存泄漏问题。</p><p>内存泄漏问题可以根据其特性按照多个维度进行分类，大致有：</p><p>触发条件</p><p>时间特性</p><p>泄漏内存量</p><p>泄漏位置数量</p><p>触发条件</p><p>指泄漏出现的条件，可以分为：偶发、必现。</p><p>时间特性</p><p>指程序的生命周期内，泄漏出现的时间情况，大体可分为：持续性泄漏 和 非持续性泄漏，细一点可以分为启动时泄漏，运行过程中泄漏，退出时泄漏，长时间，短时间等等。</p><p>泄漏内存量</p><p>指单次泄漏发生时所消耗的内存量，这个维度本身可被量化，但大体可分为：少量泄漏，大量泄漏。</p><p>泄漏位置数量</p><p>指程序中引发泄漏的问题出处，大体可分为：少处泄漏，多处泄漏。</p><p>有了时间和泄漏量就能有泄露速度，可以延伸出泄漏的速度：快速泄漏和缓慢泄漏。</p><p>从功用的角度来看，并非所有的内存泄露都需要花费时间去跟踪，比如只在系统退出时才会产生的泄漏，比如非常少量的非持续性泄漏。</p><p>强迫症同事不允许有瑕疵，怎么能存在泄漏？必须消灭。</p><p><strong>哪种内存泄露最难跟踪？</strong></p><p>是这种：</p><p>偶发性，持续，缓慢，多处内存泄露。</p><p>如果你的项目遇到这种情况，不好意思，准备好掉头发。</p><p>但是转念一想，维护糟糕的项目能够发展你的核心技能。</p><p>跟踪内存泄漏问题往往使用动态跟踪技术，而非静态检查。</p><p>jemalloc的Profiling就是动态跟踪技术，在程序运行时分析。</p><h2 id="_4-profiling的内在逻辑" tabindex="-1"><a class="header-anchor" href="#_4-profiling的内在逻辑"><span><strong>4. Profiling的内在逻辑</strong></span></a></h2><p><strong>【切片】</strong><br> 一词，是自己瞎翻译的，反正国内对这个问题也没有业界统一的叫法，就让我用捉急的英文勉强翻译一下。</p><p>在<br> jemalloc的官方文档上叫Profiling，简写成p<br> rof。</p><p>词典对Profiling的解释是：</p><p>描…的轮廓</p><p>切片要表达一个意思：</p><p>截取大的物体上的一点东西下来分析，以获得物体的一个概要信息。</p><p>准确的说，这里的Profiling是指Heap Profiling，堆内存切片。</p><p>既然是堆内存分配器，当然就只能管理堆上的内存。</p><p>jemalloc内部会有一个抽象意义上的allocate table(不是真的有)，用于存放内存指针与内存信息的关联关系。</p><p>简化后这个表的逻辑大概是这个样子：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">allocate</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> table:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">内存指针</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">           申请的内存量</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ptr1(0x000000123</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) 56bytes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ptr2(0x000000456</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) 26bytes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ptr3(0x000000789</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) 1024bytes</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">......</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>‍</p><p>当开启prof时，</p><p>在应用程序调用malloc的时候，jemalloc会存储调用堆栈和申请到的内存指针，以及申请的内存大小。</p><p>free的时候将ptr指针所对应的内存申请size值从内存申请映射表中减掉。</p><p>举个例子：</p><p>ptr = malloc(size);</p><p>多次调用malloc后形成：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">allocate</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> table:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">内存指针</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">           申请的内存量</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ptr1(0x000000123</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) 56bytes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ptr2(0x000000456</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) 26bytes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ptr3(0x000000789</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) 1024bytes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>‍</p><p>allocate table 的表达能力有限，不能以此分析输出代码问题发生的位置，需要另外使用函数调用栈来表达内存分配信息。</p><p>所以需要构造调用栈映射表(抽象意义上的，并非真有)：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">call</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> stack</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> map:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">内存指针</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">            调用栈</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">       申请内存量（可查allocate</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> table得到）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ptr1(0x000000123</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)  callstack1   56bytes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ptr2(0x000000456</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)  callstack2   26bytes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ptr3(0x000000789</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)  callstack1   1024bytes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>调用free(ptr3)后：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">call</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> stack</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> map:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">内存指针</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">            调用栈</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">       申请内存量（可查allocate</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> table得到）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ptr1(0x000000123</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)  callstack1   56bytes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ptr2(0x000000456</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)  callstack2   26bytes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">allocate</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> table:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">内存指针</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">           申请的内存量</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ptr1(0x000000001</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) 56bytes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ptr2(0x000000456</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) 26bytes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其他的类<br> jemalloc的工具都有类似的处理逻辑，但各个工具的内部实现细节各不相同。</p><p>概括起来，其核心就是维护了一个以 [调用栈] 为键，键值为 [复合统计值] 的 [映射表]。</p><p>当然<br> jemalloc中的调用栈映射表比我们这里描述的要复杂，除了总字节数之外其中还包含：</p><p>线程编号、分配对象个数、累计分配对象个数、累计分配字节数。</p><p>其中：</p><p>线程编号：<br> 如其名字。</p><p>分配对象个数：<br> 是<br> 指某个调用栈尚未释放的内存申请的计数值，调用一次malloc函数该计数值增加1，调用一次fre<br> e函数该计数值减1。</p><p>累计分配对象个数：<br> 是指某个调用栈总的内存申请的计数值，调用一次malloc函数该计数值增加1，调用free的时候并不会减1。这个统计值默认是关闭的，可通过prof_accum选项打开。</p><p>累计分配字节数：<br> 是指某个调用栈总的内存申请的字节计数值，调用一次malloc函数该计数值增加申请的字节数，调用free的时候并不会减去释放的内存的字节数。这个统计值默认是关闭的，可通过prof_accum选项打开。</p><p>而且<br> jemalloc的heap文件中对调用栈进行了聚合，相同调用栈只有一条记录数据。</p><p>理解了本文说的这种简要模型就足够使用<br> jemalloc的切片能力了。</p><p>jemalloc里，在切片操作发生时，将导出内存申请映射表，生成heap文件。</p><p>最终我们可以使用jeprof工具遍历该映射表，以调用栈为中心对内存申请量进行统计，最终生成树形的内存消耗调用关系。</p><p><strong>对于内存泄漏问题：</strong></p><p>jemalloc直接提供了分析能力。基本原理也是在程序启动时开始进行prof记录，在程序退出时将[调用栈映射表]导出成heap文件，该heap文件就直接表明了内存泄漏的函数调用栈。</p><p><strong>对于内存增长问题：</strong></p><p>jemalloc提供了足够的接口，在内存增长之前激活prof记录功能，等到增长完成后，我们通过调用接口dump出[调用栈映射表]到heap文件中，该heap文件直接表明了内存增长的函数调用栈。</p><p>另外，我们也可以通过接口在内存增长之前生成一个heap1， 在内存增长后再生成一个heap2，通过jeprof工具对比heap1和heap2的差异，找出增长的函数调用栈。</p><p>内存泄漏问题我们也可以使用这种方法来跟踪。</p><h2 id="_5-jemalloc的使用方式" tabindex="-1"><a class="header-anchor" href="#_5-jemalloc的使用方式"><span><strong>5. Jemalloc的使用方式</strong></span></a></h2><p>我们需要安装开发版本<br> jemalloc库和graphviz库</p><p>jemalloc的使用方式主要有2种：</p><ol><li><p>通过静态链接，链接到可执行文件中。<br> 这需要修改代码，运行时没有任何依赖。</p></li><li><p>使用LD_PRELOAD指定<br> jemalloc的动态库路径，预装载到进程空间中，替换ptmalloc的接口。<br> 这种方式使用最简单，灵活度最高，因为出jemalloc之外的其他内存分配器也使用这种方式，这就能够在客户环境中非常轻松地更换内存分配器。<br> 不过也有缺陷，动态库的方式在函数调用时会多一次符号查找，因此性能会有非常轻微的降低。<br> 一般的程序，这点下降几乎感知不到。</p></li></ol><h2 id="_6-jemalloc的安装" tabindex="-1"><a class="header-anchor" href="#_6-jemalloc的安装"><span><strong>6. Jemalloc的安装</strong></span></a></h2><p>我们需要安装开发版本jemalloc库和graphviz库</p><p>graphviz库用于绘图生成pdf文件</p><p>kcachegrind软件可选安装，用于交互查看调用图。</p><p><strong>centos上安装</strong></p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">yum</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jemalloc-devel</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">yum</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> graphviz</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[可选] yum install kdesdk-kcachegrind</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ubuntu上安装</strong></p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> libjemalloc-dev</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> graphviz</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[可选] apt-get install kcachegrind</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们可以通过查看安装后的文件列表来获取jemalloc的库文件和头文件位置：</p><p><strong>在centos上执行</strong></p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">rpm</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -ql</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jemalloc-devel</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>在ubuntu上执行</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>dpkg -L libjemalloc-dev</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>结果如下：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/bin</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/bin/jeprof</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/include</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/include/jemalloc</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/include/jemalloc/jemalloc.h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/lib</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/lib/x86_64-linux-gnu</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/lib/x86_64-linux-gnu/libjemalloc.a</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/lib/x86_64-linux-gnu/libjemalloc_pic.a</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/lib/x86_64-linux-gnu/pkgconfig</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/lib/x86_64-linux-gnu/pkgconfig/jemalloc.pc</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/share</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/share/doc</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/share/doc/libjemalloc-dev</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/share/doc/libjemalloc-dev/copyright</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/share/doc/libjemalloc-dev/jemalloc.html</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/share/doc-base</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/share/doc-base/libjemalloc-dev</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/share/man</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/share/man/man1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/share/man/man1/jeprof.1.gz</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/share/man/man3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/share/man/man3/jemalloc.3.gz</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/lib/x86_64-linux-gnu/libjemalloc.so</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/share/doc/libjemalloc-dev/README</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/share/doc/libjemalloc-dev/changelog.Debian.gz</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-jemalloc关键文件说明" tabindex="-1"><a class="header-anchor" href="#_7-jemalloc关键文件说明"><span><strong>7. Jemalloc关键文件说明</strong></span></a></h2><p>一般，我们主要使用如下几个文件：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">使用LD_PRELOAD时，仅需使用动态库：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/lib/x86_64-linux-gnu/libjemalloc.so</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">使用编译时链接的方式，需要如下文件：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/lib/x86_64-linux-gnu/libjemalloc.a</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/lib/x86_64-linux-gnu/libjemalloc_pic.a</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/include/jemalloc/jemalloc.h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">jemalloc.h和libjemalloc.a</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 看名字就知道，编译时静态链接需要用的头文件和静态库。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>特别的：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">libjemalloc_pic.a用于链接那些编译时使用了位置无关编译策略的程序。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>要想使用内存切片功能，需要保证编译jemalloc的库时，开启了prof编译选项。</p><p>对于我们安装的rpm或者deb包，可以通过执行如下命令来测试来确认jemalloc的prof功能是否被编译：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">MALLOC_CONF</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">stats_print:true</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> LD_PRELOAD</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/usr/lib/x86_64-linux-gnu/libjemalloc.so</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> sed</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;xxxxx&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./</span><span style="--shiki-light:#005CC5;--shiki-dark:#E5C07B;">*</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>如果prof功能被编译，则输出结果中的config.prof一项值应该为true</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sed:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> expression</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> #1, char 2: extra characters after command</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">___</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Begin</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jemalloc</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> statistics</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ___</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Version:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;5.2.0-0-gb0b3e49a54ec29e32636f4577d9d5a896d67fd20&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Build-time</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> option</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> settings</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  config.cache_oblivious:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  config.debug:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> false</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  config.fill:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  config.lazy_lock:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> false</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  config.malloc_conf:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  config.prof:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  config.prof_libgcc:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  config.prof_libunwind:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> false</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  config.stats:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">  ......</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>‍</p><p>关注这项：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">config.prof:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>还有我们的切片分析工具</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/usr/bin/jeprof</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>jeprof是一个脚本工具，由perl语言所编写。</p><p>主要提供的能力：</p><ol><li><p>反汇编指定函数；</p></li><li><p>分析和可视化jemalloc生成的heap文件，可使用top命令查看消耗热点函数排序结果；</p></li><li><p>多种格式的分析结果输出：pdf文件、文本、callgrind等多种格式；</p></li><li><p>对比2个不同的heap文件的差异；</p></li></ol><h2 id="_8-编译带prof功能的jemalloc库" tabindex="-1"><a class="header-anchor" href="#_8-编译带prof功能的jemalloc库"><span><strong>8. 编译带prof功能的jemalloc库</strong></span></a></h2><p>如果通过yum和apt安装的libjemalloc没有prof功能，就需要自己手动编译。</p><p>步骤很简单：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">wget</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> https://github.com/jemalloc/jemalloc/archive/refs/tags/5.2.1.tar.gz</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">tar</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -zxvf</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 5.2.1.tar.gz</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jemalloc-5.2.1/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">./autogen.sh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">./configure</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --prefix=/usr/local/jemalloc-5.2.1</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --enable-prof</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">make</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -j</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> install</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-内存泄漏和内存增长测试例子" tabindex="-1"><a class="header-anchor" href="#_9-内存泄漏和内存增长测试例子"><span><strong>9. 内存泄漏和内存增长测试例子</strong></span></a></h2><p>我们编写一个测试代码，用于验证jemalloc的Profiling能力。</p><p>该测试程序提供多个函数调用的路径去申请内存，并且随机调用free，模拟内存泄漏和内存增长。</p><p>其中包含了调用jemalloc接口的例子。</p><p>主要使用了2个接口：</p><div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" data-title="c++" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> mallctl</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(  </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">   void</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">oldp</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">   size_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">oldlenp</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">   void</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">newp</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">   size_t</span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> newlen</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> malloc_stats_print</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(  </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (*</span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">write_cb</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) (</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) ,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">   void</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">cbopaque</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">opts</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>主要通过mallctl来实现对jemalloc的控制。</p><p>通过向测试程序发送signal来控制程序的行为，如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>信号ID         动作</span></span>
<span class="line"><span>SIGUSR1        进行Profiling的heap文件dump操作</span></span>
<span class="line"><span>SIGUSR2        激活Profiling，新的malloc从此时才能被记录</span></span>
<span class="line"><span>SIGRTMIN+10    输出jemalloc的内部统计信息</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码如下：</p><div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" data-title="c++" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &lt;stdint.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &lt;stdio.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &lt;stdlib.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &lt;iostream&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &lt;random&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &lt;signal.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &lt;unistd.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &lt;jemalloc/jemalloc.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">//生成指定范围的随机数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">template</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">typename</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> T</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> random</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> range_from</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> range_to</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">    std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::random_device                  rand_dev;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">    std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::mt19937                        </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">generator</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">rand_dev</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">    std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::uniform_int_distribution</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">T</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    distr</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(range_from, range_to);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> distr</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(generator);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">//为了触发缺页中断分配物理内存</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#ABB2BF;">__attribute__ ((</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">noinline</span><span style="--shiki-light:#005CC5;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> access_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">void*</span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">size_t</span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> s</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">nullptr</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ptr) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">size_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> s; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">i){</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    ((</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">uint8_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)ptr)[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> i;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#ABB2BF;">__attribute__ ((</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">noinline</span><span style="--shiki-light:#005CC5;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> fun_leak_1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  void</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> p </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1024</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  access_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(p, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1024</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">random</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">uint32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)){</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    free</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(p);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#ABB2BF;">__attribute__ ((</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">noinline</span><span style="--shiki-light:#005CC5;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> fun_leak_2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  void</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> p </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1024</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  access_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(p, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1024</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">random</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">uint32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)){</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    free</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(p);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#ABB2BF;">__attribute__ ((</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">noinline</span><span style="--shiki-light:#005CC5;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> fun_leak_3</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  void</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> p </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1024</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  access_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(p, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1024</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">random</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">uint32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)){</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    free</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(p);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#ABB2BF;">__attribute__ ((</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">noinline</span><span style="--shiki-light:#005CC5;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> fun_leak_4</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  void</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> p </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1024</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  access_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(p, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1024</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">random</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">uint32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)){</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    free</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(p);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#ABB2BF;">__attribute__ ((</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">noinline</span><span style="--shiki-light:#005CC5;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> fun_leak_recu</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">uint32_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">level</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">){</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(level </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 6</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(level </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">&lt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> ||</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> random</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">uint32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)){</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      fun_leak_recu</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">level);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    uint32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> w </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> random</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">uint32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    switch</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (w)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    case</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      fun_leak_1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">      break</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    case</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      fun_leak_2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">      break</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    case</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      fun_leak_3</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">      break</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    case</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      fun_leak_4</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">      break</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    default</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">      break</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#ABB2BF;">__attribute__ ((</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">noinline</span><span style="--shiki-light:#005CC5;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> fun_big_malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  void</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> p </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1024</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#ABB2BF;">__attribute__ ((</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">noinline</span><span style="--shiki-light:#005CC5;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> fun_root</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(){</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    fun_big_malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    uint32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> level </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    fun_leak_recu</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(level);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> sig_usr</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> signo</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (signo </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> SIGUSR1)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">    std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::cout </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;received SIGUSR1, run prof.dump!</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::endl;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    mallctl</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;prof.dump&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  else</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (signo </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> SIGUSR2)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">    std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::cout </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;received SIGUSR2, run prof.active!</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::endl;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    bool</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> active </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    mallctl</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;prof.active&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">active, </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(active));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  else</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (signo </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (SIGRTMIN</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)){</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">    std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::cout </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;received SIGRTMIN+10, run malloc_stats_print!</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::endl;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    malloc_stats_print</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">nullptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">nullptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> RegistrySignal</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">signal</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(SIGUSR1, sig_usr) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> SIG_ERR)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">    std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::cout </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;signal1 error!&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::endl; </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">signal</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(SIGUSR2, sig_usr) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> SIG_ERR)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">    std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::cout </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;signal2 error!&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::endl; </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">signal</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(SIGRTMIN</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, sig_usr) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> SIG_ERR)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">    std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::cout </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;signal3 error!&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::endl; </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> argc</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">char</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> **</span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">argv</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">  std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::cout </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;---&gt;Begin test&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::endl;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  RegistrySignal</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">  std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::cout </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;---&gt;wait op&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::endl;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  //等待3秒，以方便外部操作</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  usleep</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">  std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::cout </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;---&gt;Begin allocate&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::endl;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">int32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">){</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    fun_root</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    usleep</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">200000</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">  std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::cout </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;---&gt;wait op2&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::endl;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  //等待3秒，以方便外部操作</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  usleep</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">  std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::cout </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;---&gt;End test&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> std</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">::endl;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  return</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>‍</p><h2 id="_10-编译测试程序" tabindex="-1"><a class="header-anchor" href="#_10-编译测试程序"><span><strong>10. 编译测试程序</strong></span></a></h2><p>目录结构如下：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">root@#</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ls</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -lh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">-rw-r--r--</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 4.7K</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 9月</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 09:08</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jemalloc_heap_profiling.cpp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">drwxr-xr-x</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 4.0K</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 9月</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 10:43</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jeprof</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>链接静态库编译：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">g++</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jemalloc_profiling_test</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jemalloc_heap_profiling.cpp</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -std=c++11</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -g</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -m64</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -l:libjemalloc.a</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -lpthread</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -ldl</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>链接动态库编译：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">g++</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jemalloc_profiling_test</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jemalloc_heap_profiling.cpp</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -std=c++11</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -g</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -m64</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -ljemalloc</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>其他编译说明：</strong></p><p>最好带上调试符号，否则有可能解析不出调用堆栈。</p><p>如果程序在客户现场出现问题，并且程序已经过瘦身，情况紧急，需要先抓取数据，只要被裁剪的符号还在，也有办法解析出调用栈。</p><p>基本思路：</p><p>把裁剪后的符号通过eu-unstrip命令再拼接回去，然后再使用jeprof工具，分析heap文件和带符号信息的可执行文件。</p><p>jeprof的--add_lib参数可以指定带符号的库路径，--lib_prefix参数可指定库路径前缀，--lines参数可以显示代码对应位置。</p><p>如果不想使用这些参数，也可以将出现问题的可执行文件部署在与现场相同的路径上，然再使用jeprof分析。</p><h2 id="_11-jemalloc运行时控制" tabindex="-1"><a class="header-anchor" href="#_11-jemalloc运行时控制"><span><strong>11. Jemalloc运行时控制</strong></span></a></h2><p>在测试之前，先介绍一下jemalloc运行时的控制方法。</p><p>11.1  通过环境变量</p><p>通过设置环境变量MALLOC_CONF，我们可以控制jemalloc在运行时的行为，具体的配置项请参考jemalloc的官方手册。例如：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">MALLOC_CONF</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">stats_print:true</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> test_program</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>多个选项使用“,”分割，例如：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">MALLOC_CONF</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">prof:true,stats_print:true</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> test_program</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_11-2-通过接口" tabindex="-1"><a class="header-anchor" href="#_11-2-通过接口"><span>11.2  通过接口</span></a></h3><p>MALLOC_CONF中可配置的选项也可以通过接口调用的方式，例如：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">bool</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> active</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">mallctl(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">&quot;prof.active&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> NULL,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> NULL,</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">active,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">active</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">));</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_11-3-启用和激活prof" tabindex="-1"><a class="header-anchor" href="#_11-3-启用和激活prof"><span>11.3  启用和激活prof</span></a></h3><p>jemalloc提供了profiling功能的两种开启方式：启用和激活。</p><p>必须先启用才能激活，只有激活了才能进行profiling分析。</p><p>选项prof可用于开启profiling功能，如：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">启用：</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    MALLOC_CONF</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">prof:true</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">禁用：</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    MALLOC_CONF</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">prof:false</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>选项prof_active可用于激活profiling功能，如：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">暂停profiling：</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    MALLOC_CONF</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">prof_active:false</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">激活profiling：</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    MALLOC_CONF</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">prof_active:true</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于运行一段时间后才激活prof功能的情况，有可能错过内存分配的时机，造成切片不准确。</p><h3 id="_11-4-profiling的输出" tabindex="-1"><a class="header-anchor" href="#_11-4-profiling的输出"><span>11.4  profiling的输出</span></a></h3><p>prof会将内部的函数调用映射表导出生成后缀为&quot;heap&quot;的文件。</p><p>配置heap文件的输出路径</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">prof_prefix:./jeprof/test</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">“./jeprof/test”指示的是生成的heap文件的前缀，准确来说是路径前缀，生成文件的路径如下：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">./jepprof/test.xxx.heap</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_11-5-profiling的基本流程" tabindex="-1"><a class="header-anchor" href="#_11-5-profiling的基本流程"><span>11.5  profiling的基本流程：</span></a></h3><p>概括说就是2个流程：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> 采样</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 导出</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>采样的目的是为了忽略一些细节，保留一个整体概要信息。</p><p>导出是指将内存中的分配信息导出到文件中。</p><p>其中采样流程可控制采集间隔参数：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>选项：lg_prof_sample:19</span></span>
<span class="line"><span>      其中19指512KiB(2^19 B)。</span></span>
<span class="line"><span></span></span>
<span class="line"><span>该参数的含义：</span></span>
<span class="line"><span>      内存分配采样之间的平均间隔，表示分配的字节数。</span></span>
<span class="line"><span>      增加采样间隔降低了切片的保真度，但也降低了计算开销。默认的采样间隔为512KiB(2^19B)。</span></span>
<span class="line"><span>      将lg_prof_sample设置为0时能够最大程度的保留内存分配的信息。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_11-6-触发profiling的2类方法" tabindex="-1"><a class="header-anchor" href="#_11-6-触发profiling的2类方法"><span>11.6  触发profiling的2类方法</span></a></h3><ol><li>jemalloc内部自动切片；</li></ol><p>分为：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">a.</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 退出时dump</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   配置项：prof_final:true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">b.</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 超过上一次内存消耗最大值时dump</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   配置项：prof_gdump:true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">c.</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 增量达到门限时dump</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   配置项：lg_prof_interval:12</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   12表示4KB(2^12</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>应用程序通过接口完成；</li></ol><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">mallctl(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">&quot;prof.dump&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> NULL,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> NULL,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> NULL,</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_12-测试-直接使用内存泄漏检查功能" tabindex="-1"><a class="header-anchor" href="#_12-测试-直接使用内存泄漏检查功能"><span><strong>12. 测试：直接使用内存泄漏检查功能</strong></span></a></h2><p>Jemalloc直接提供了内存泄漏检查的能力，它会再程序正常结束时检查内存泄漏，并输出heap文件。以如下方式运行编译好的测试程序：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">root@#</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> MALLOC_CONF=prof_leak:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,lg_prof_sample:0,prof_final:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,prof_prefix:./jeprof/test</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jemalloc_profiling_test</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">Begin</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> test</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">wait</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> op</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">End</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> test</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">jemalloc</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: Leak approximation summary: </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">2182144 bytes, </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">336 objects, </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">= 30 contexts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">jemalloc</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: Run jeprof on </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;./jeprof/test.71646.0.f.heap&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> leak detail</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>关键就是“<br> prof_leak:true”和“<br> prof_final:true”发挥了作用。</p><p>“<br> lg_prof_sample:0”指示着不要错过任何分配，尽最大力量还原信息，当然，这是有开销的。</p><p>我们看到jemalloc的内存泄漏报告和生成的heap文件：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>&lt;jemalloc&gt;: Leak approximation summary: ~2182144 bytes, ~336 objects, &gt;= 30 contexts</span></span>
<span class="line"><span>&lt;jemalloc&gt;: Run jeprof on &quot;./jeprof/test.71646.0.f.heap&quot; for leak detail</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>查看下heap文件：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">root@#</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ls</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jeprof/</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -lht</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">total</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 12K</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">-rw-r--r--</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 12K</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 9月</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 10:40</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> test.71646.0.f.heap</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我需要通过jeprof工具来对heap文件进行分析。</p><p>以交互方式查看，如下：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">root@#</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jeprof</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --show_bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  ./jemalloc_profiling_test</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jeprof/test.71646.0.f.heap</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Using</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> local</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jemalloc_profiling_test.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Using</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> local</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jeprof/test.71646.0.f.heap.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Welcome</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jeprof!</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  For</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> help,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> type</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;help&#39;.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">jeprof</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">top</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Total:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 2182144</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> B</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> 2182144</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  2182144</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> je_prof_backtrace</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    81920</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   3.8%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> GLIBC_2.2.5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     1024</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> _IO_doallocbuf</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     1024</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> _IO_file_doallocate</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     1024</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> _IO_file_overflow</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     1024</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> _IO_file_xsputn</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  2100224</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  96.2%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> __libc_start_main</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    81920</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   3.8%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> _dl_rtld_di_serinfo</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  2100224</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  96.2%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> _start</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  1024000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  46.9%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_big_malloc</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">jeprof</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">top33</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Total:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 2182144</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> B</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> 2182144</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  2182144</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> je_prof_backtrace</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    81920</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   3.8%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> GLIBC_2.2.5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     1024</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> _IO_doallocbuf</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     1024</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> _IO_file_doallocate</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     1024</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> _IO_file_overflow</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     1024</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> _IO_file_xsputn</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  2100224</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  96.2%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> __libc_start_main</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    81920</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   3.8%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> _dl_rtld_di_serinfo</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  2100224</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  96.2%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> _start</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  1024000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  46.9%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_big_malloc</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    58368</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   2.7%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_leak_1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   110592</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   5.1%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_leak_2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   353280</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  16.2%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_leak_3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   552960</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  25.3%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_leak_4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  1075200</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  49.3%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_leak_recu</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  2099200</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  96.2%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_root</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     1024</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fwrite</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  2182144</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> je_malloc_default</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  2100224</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  96.2%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> main</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     1024</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> std::__ostream_insert</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    81920</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   3.8%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> std::__throw_ios_failure</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     1024</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> std::operator</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;&lt; </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">jeprof</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">disasm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_leak_recu</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Total:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 2182144</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> B</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ROUTINE</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ======================</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_leak_recu</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">     0</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1915904</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> B</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (flat, </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">cumulative</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) 87.8% of total</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">--------------------</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ...sts/jemalloc_heap_profiling/jemalloc_heap_profiling.cpp</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    92:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> void</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_leak_recu</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">uint32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">level</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d15:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> endbr64</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d19:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> push</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   %rbp</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d1a:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mov</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    %rsp,%rbp</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d1d:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sub</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    $0x20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,%rsp</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d21:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mov</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    %rdi,-0x18</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">%rbp</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    94:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">level</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 6</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d25:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mov</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    -0x18(%rbp</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">),%rax</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d29:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mov</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    (%rax),%eax</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d2b:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cmp</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    $0x6</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,%eax</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d2e:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ja</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     7dd4</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_recu+0xb</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">f</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    98:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">level</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> ||</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> random</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;uint32_t&gt;(0, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)){</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d34:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mov</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    -0x18(%rbp</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">),%rax</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d38:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mov</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    (%rax),%eax</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d3a:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cmp</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    $0x2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,%eax</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d3d:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jbe</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    7d52</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_recu+0x3</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">d</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d3f:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mov</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    $0x1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,%esi</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d44:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mov</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    $0x0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,%edi</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d49:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> callq</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  8272</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">unsigned</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> int</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> rando</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">m</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d4e:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> test</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   %eax,%eax</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d50:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> je</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     7d59</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_recu+0x4</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">4&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d52:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mov</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    $0x1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,%eax</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d57:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jmp</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    7d5e</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_recu+0x4</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">9&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d59:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mov</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    $0x0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,%eax</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d5e:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> test</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   %al,%al</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d60:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> je</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     7d7d</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_recu+0x6</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">8&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 840704</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    99:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_leak_recu</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">++level</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d62:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mov</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    -0x18(%rbp</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">),%rax</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d66:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mov</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    (%rax),%eax</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d68:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> lea</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    0x1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">%rax</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,%edx</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d6b:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mov</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    -0x18(%rbp</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">),%rax</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d6f:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mov</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    %edx,</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">%rax</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d71:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mov</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    -0x18(%rbp</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">),%rax</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d75:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mov</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    %rax,%rdi</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 840704</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d78:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> callq</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  7d15</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_rec</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">u</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   102:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> uint32_t</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> w</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> random</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">uint32_</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">t</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&gt;(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">1,</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 4</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d7d:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mov</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    $0x4</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,%esi</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d82:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mov</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    $0x1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,%edi</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d87:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> callq</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  8272</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">unsigned</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> int</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> rando</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">m</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d8c:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mov</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    %eax,-0x4</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">%rbp</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   103:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> switch</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (w)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d8f:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cmpl</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">   $0x4</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,-0x4</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">%rbp</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d93:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> je</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     7dca</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_recu+0xb</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">5&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d95:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cmpl</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">   $0x4</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,-0x4</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">%rbp</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d99:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ja</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     7dd1</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_recu+0xb</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">c</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d9b:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cmpl</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">   $0x3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,-0x4</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">%rbp</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7d9f:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> je</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     7dc3</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_recu+0xa</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7da1:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cmpl</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">   $0x3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,-0x4</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">%rbp</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7da5:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ja</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     7dd1</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_recu+0xb</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">c</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7da7:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cmpl</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">   $0x1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,-0x4</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">%rbp</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7dab:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> je</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     7db5</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_recu+0xa</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">0&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7dad:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cmpl</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">   $0x2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,-0x4</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">%rbp</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7db1:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> je</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     7dbc</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_recu+0xa</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">7&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   118:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> break</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7db3:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jmp</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    7dd1</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_recu+0xb</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">c</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  58368</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   106:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_leak_1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  58368</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7db5:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> callq</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  7bcd</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">1&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   107:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> break</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7dba:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jmp</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    7dd2</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_recu+0xb</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">d</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 110592</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   109:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_leak_2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 110592</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7dbc:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> callq</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  7c1f</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">2&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   110:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> break</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7dc1:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jmp</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    7dd2</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_recu+0xb</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">d</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 353280</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   112:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_leak_3</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 353280</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7dc3:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> callq</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  7c71</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">3&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   113:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> break</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7dc8:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jmp</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    7dd2</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_recu+0xb</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">d</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 552960</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   115:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_leak_4</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 552960</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7dca:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> callq</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  7cc3</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">4&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   116:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> break</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7dcf:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jmp</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    7dd2</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_recu+0xb</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">d</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   118:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> break</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7dd1:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    nop</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   121:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> return</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7dd2:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jmp</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    7dd5</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">fun_leak_recu+0xc</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">0&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    95:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> return</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7dd4:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    nop</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   122:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7dd5:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> leaveq</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      .</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        7dd6:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> retq</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">   </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">jeprof</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">quit</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">root@#</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们看到了泄漏最高的函数名字：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  2100224</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  96.2%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> _start</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  1024000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  46.9%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_big_malloc</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    58368</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   2.7%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_leak_1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   110592</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   5.1%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_leak_2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   353280</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  16.2%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_leak_3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   552960</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  25.3%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_leak_4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  1075200</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  49.3%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_leak_recu</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   0.0%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 100.0%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  2099200</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  96.2%</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fun_root</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于没有分析累计统计，所以前几列的值都为0，这不影响我们的分析。</p><p>我们可以同pdf的方式来查看，以获得更直观的结果，如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>root@# jeprof --show_bytes --pdf ./jemalloc_profiling_test ./jeprof/test.71646.0.f.heap &gt; ./jeprof/je_check_leak.pdf</span></span>
<span class="line"><span>Using local file ./jemalloc_profiling_test.</span></span>
<span class="line"><span>Using local file ./jeprof/test.71646.0.f.heap.</span></span>
<span class="line"><span>Dropping nodes with &lt;= 10910 B; edges with &lt;= 2182 abs(B)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们打开</p><p>“<br> ./jeprof/je_check_leak.pdf”</p><p>可以看到：</p><figure><img src="/assets/je_check_leak-CnG0DkLJ.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>内存泄漏的函数调用路径一目了然。</p><h2 id="_13-测试-通过heap对比来分析泄漏和增长" tabindex="-1"><a class="header-anchor" href="#_13-测试-通过heap对比来分析泄漏和增长"><span><strong>13. 测试：通过heap对比来分析泄漏和增长</strong></span></a></h2><p>通过heap对比来分析泄漏和增长。</p><p>在一个shell窗口中启动测试程序：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">root@#</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mkdir</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jeprof</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">root@#</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> MALLOC_CONF=prof:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,lg_prof_sample:0,prof_active:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">false</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,prof_prefix:./jeprof/test</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jemalloc_profiling_test</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">Begin</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> test</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">wait</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> op</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">received</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> SIGUSR2,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> prof.active!</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">Begin</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> allocate</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">received</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> SIGUSR1,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> prof.dump!</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">received</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> SIGUSR1,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> prof.dump!</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">received</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> SIGUSR1,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> prof.dump!</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">received</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> SIGUSR1,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> prof.dump!</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">wait</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> op2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">End</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> test</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在另一个shell窗口中发送控制信号：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">root@#</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kill</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -SIGUSR2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  $(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">pidof</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jemalloc_profiling_test</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">root@#</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kill</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -SIGUSR1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  $(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">pidof</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jemalloc_profiling_test</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">root@#</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kill</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -SIGUSR1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  $(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">pidof</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jemalloc_profiling_test</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">root@#</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kill</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -SIGUSR1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  $(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">pidof</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jemalloc_profiling_test</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">root@#</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kill</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -SIGUSR1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  $(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">pidof</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jemalloc_profiling_test</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动时，我们将prof_active设置为false，此时jemalloc不会进行prof采样。</p><p>在操作等待时间内我们，发送了prof激活信号。</p><p>然后进行了多次dump操作。</p><p>最终生成的结果：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">root@#</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ls</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jeprof/</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -lht</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">total</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 68K</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">-rw-r--r--</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  11K</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 9月</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 11:12</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> test.72297.3.m3.heap</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">-rw-r--r--</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  11K</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 9月</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 11:12</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> test.72297.2.m2.heap</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">-rw-r--r--</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 9.5K</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 9月</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 11:11</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> test.72297.1.m1.heap</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">-rw-r--r--</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 5.6K</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 9月</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 11:11</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> test.72297.0.m0.heap</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>分析结果：</p><p>一共dump了4次，生成了4个heap文件</p><p>test.72297.0.m0.heap是在激活prof后，第一次生成的heap，此时并未执行任何的内存申请操作，因此其中不包含映射表。</p><p>我们挑选test.72297.2.m2.heap和test.72297.1.m1.heap两次dump来做比较，可以分析内存泄漏发生的位置。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">root@#</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jeprof</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --pdf</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --show_bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jemalloc_profiling_test</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jeprof/test.72297.2.m2.heap</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --base=./jeprof/test.72297.1.m1.heap</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jeprof/je_leak_grow_api_1.pdf</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Using</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> local</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jemalloc_profiling_test.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Using</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> local</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jeprof/test.72297.2.m2.heap.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dropping</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nodes</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1853</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> B</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">edges</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 370</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> abs</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">B</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>‍</p><p>结果如下：</p><figure><img src="/assets/je_leak_grow_api_1-P6EMHWRt.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可以再对比最早的和最晚的2次heap：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">root@#</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> jeprof</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --pdf</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --show_bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jemalloc_profiling_test</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jeprof/test.72297.3.m3.heap</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --base=./jeprof/test.72297.0.m0.heap</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jeprof/je_leak_grow_api_2.pdf</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Using</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> local</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jemalloc_profiling_test.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Using</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> local</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jeprof/test.72297.3.m3.heap.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dropping</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nodes</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 7808</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> B</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">edges</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1561</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> abs</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">B</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果如下：</p><figure><img src="/assets/je_leak_grow_api_2-BLGvfV2L.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>通过pdf图我们看到了所有内存增长的位置。</p><p>检查代码会发现泄漏的调用路径和内存增长的位置与图中吻合。</p><h2 id="_14-jeprof工具的用法举例" tabindex="-1"><a class="header-anchor" href="#_14-jeprof工具的用法举例"><span><strong>14. jeprof工具的用法举例</strong></span></a></h2><p>jeprof还有非常多的其它用法，本文再列举些例子。</p><p>以文本形式输出：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">jeprof</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --show_bytes</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --text</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jemalloc_profiling_test</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jeprof/test.55046.0.m0.heap</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>当调用栈很多时，jeprof会省略许多信息，此时想查看细微的信息，可以这样：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>jeprof --pdf --inuse_space --show_bytes --nodecount=1000 --nodefraction=0.000001 --edgefraction=0.000001 --maxdegree=100 ./jemalloc_profiling_test ./jeprof/test.55046.0.m0.heap &gt; test.pdf</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>显示代码行数：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">jeprof</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --lines</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --show_bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jemalloc_profiling_test</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jeprof/test.72297.3.m3.heap</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --base=./jeprof/test.72297.0.m0.heap</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>以callgrind格式输出：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">jeprof</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --callgrind</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --show_bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jemalloc_profiling_test</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./jeprof/test.72297.3.m3.heap</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cachegrind.out</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>‍将生成的“<br> cachegrind.out”用kcachegrind打开：</p><figure><img src="/assets/cachegrind-BWJSudow.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>其他用法请参考jeprof的help信息。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>jeprof -h</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_15-jemalloc内存切片的缺陷" tabindex="-1"><a class="header-anchor" href="#_15-jemalloc内存切片的缺陷"><span><strong>15. Jemalloc内存切片的缺陷</strong></span></a></h2><p>如开篇所说，Jemalloc切片方法并非万能，它有自己的缺陷：</p><p><strong>1. 系统会变慢</strong></p><p>每个malloc和每个free的函数调用都需要做更多额外操作，而且这些操作jemalloc的优化不是很充分。</p><p>一旦开启并激活了prof后，程序的性能会有大幅度下降，一倍到数倍不等等，与应用程序的特性相关，内存申请释放越频繁性能下降越明显。</p><p>有些场景下，缓慢的系统无法复现问题，甚至会产生新的阻塞造成新的内存增长问题，此时jemalloc的prof功能就无法胜任了。</p><p>面对这个问题，我们可以通过其他手段来解决，后边有机会再说。</p><p><strong>2. 无法分析消耗大量虚拟内存，但表现未物理内存泄露泄漏的问题</strong></p><p>频繁使用虚拟内存预分配的编程风格，调用了malloc，实际运行的过程中业务流程却未充分使用这些内存，虚拟内存增长很快，但是物理内存却未消耗。</p><p>内存泄漏问题往往更关注物理内存的泄漏，此种场景下，jemalloc的分析结果就变得不可信了，以此为分析的依据甚至会得到错误的结论。</p><p>面对这个问题，我们同样可以通过其他手段来解决，后边有机会再说。</p><h2 id="_16-最后" tabindex="-1"><a class="header-anchor" href="#_16-最后"><span><strong>16. 最后</strong></span></a></h2><p>如果你的程序经常要分析内存泄漏或内存消耗问题，而且发现jemalloc很合适你的场景，建议你将其工程化，在业务上提供：导出heap文件、下载heap文件、解析heap文件的能力。</p><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料"><span><strong>参考资料：</strong></span></a></h2><ul><li>[1] jemalloc的泄漏检查 https://github.com/jemalloc/jemalloc/wiki/Use-Case%3A-Leak-Checking</li><li>[2] jemalloc的heap profiling https://www.yuanguohuo.com/2019/01/02/jemalloc-heap-profiling/</li><li>[3] A-Heap-Profiling https://github.com/jemalloc/jemalloc/wiki/Use-Case%3A-Heap-Profiling</li><li>[4] Memory Profiling with Mesos and Jemalloc https://mesos.apache.org/documentation/latest/memory-profiling/</li><li>[5] jemalloc man http://jemalloc.net/jemalloc.3.html</li><li>[6] 内存泄漏 百度百科 https://baike.baidu.com/item/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/6181425?fr=aladdin</li><li>[7] 内存泄漏 维基百科 https://zh.wikipedia.org/wiki/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F</li></ul></div><!----><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/EmptyWatson/EmptyWatson.github.io/edit/main/src/zh/posts/debug/user_space/jemalloc_profiling.md" aria-label="在 GitHub 上编辑此页" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">上次编辑于: </span><!----></div><div class="contributors"><span class="vp-meta-label">贡献者: </span><!--[--><!--[--><span class="vp-meta-info" title="email: 1424599184@qq.com">cric_li</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><!----><a class="route-link auto-link next" href="/zh/posts/debug/user_space/linux_freeze_threads.html" aria-label="Linux上暂停指定的多个运行线程"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">Linux上暂停指定的多个运行线程<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">InsideWorld</div><div class="vp-copyright">Copyright © 2024 EmptyWatson </div></footer></div><!--]--><!--]--><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-Dc7jvRXf.js" defer></script>
  </body>
</html>
